# GRUB SENTINEL — автоматизация восстановления GRUB
GRUB SENTINEL v0.5 — утилита-скрипт на bash для автоматизации типичных шагов восстановления загрузчика GRUB в современных версиях Ubuntu (EFI). Скрипт ориентирован на удобный интерактивный прогресс с логированием и набором безопасных операций по восстановлению конфигурации и интерфейса GRUB.

> Файл скрипта: [grub_sentinel.sh](https://github.com/zemcoviv/grub_sentinel/blob/main/grub_sentinel.sh)

---

Содержание
- Описание
- Возможности
- Требования
- Установка
- Использование
- Что делает скрипт (кратко)
- Логирование и отладка
- Безопасность и рекомендации
- Вклад и лицензия

## Описание
Скрипт выполняет набор операций для восстановления работоспособности GRUB: очистку/восстановление состояния пакетного менеджера, настройку графического вывода (HiDPI), установку/настройку темы GRUB, восстановление системных скриптов из пакета grub2-common, переустановку EFI-загрузчика и пересборку конфигурации grub.

UI сделан в виде текста в терминале с индикатором выполнения для каждой задачи и записью вывода в лог.

## Возможности
- Автоматическая инициализация пакетного менеджера (dpkg)
- Применение графических настроек GRUB (GRUB_GFXMODE, терминал, payload)
- Поиск/установка темы Grub и обновление `/etc/default/grub`
- Восстановление содержимого `/etc/grub.d` из пакета `grub2-common`
- Переустановка grub EFI-пакетов и вызов `grub-install`
- Вызов `update-grub` (с включённым os-prober)
- Интерактивное отображение прогресса и логирование в `/tmp/grub_sentinel.log`
- Вывод итогового меню обнаруженных ОС из `/boot/grub/grub.cfg`

## Требования
- Ubuntu (или похожие дистрибутивы Debian/Ubuntu)
- Системы с EFI (скрипт выполняет grub-install для x86_64 EFI)
- Права root (скрипт принудительно завершится, если запущен не от root)
- Наличие интернета для apt (для установки/скачивания пакетов)
- Рекомендуется запуск в среде тестирования/VM перед запуском на рабочей системе

## Установка
1. Склонируйте репозиторий или поместите `grub_sentinel.sh` в нужный каталог:
```bash
git clone https://github.com/zemcoviv/grub_sentinel.git
cd grub_sentinel
```

2. Сделайте скрипт исполняемым:
```bash
chmod +x grub_sentinel.sh
```

## Использование
Запустите от root:
```bash
sudo ./grub_sentinel.sh
```

После выполнения:
- Лог выполнения будет доступен в `/tmp/grub_sentinel.log`
- В конце скрипт выводит обнаруженные записи меню (список ОС) и сообщение о завершении.

## Что делает скрипт (подробно)
1. Проверяет, запущен ли скрипт от root, иначе завершает работу.
2. Инициализирует лог-файл `/tmp/grub_sentinel.log`.
3. Инициализирует пакетный менеджер:
   - Удаляет lock-файлы dpkg и запускает `dpkg --configure -a`.
4. Настраивает графику GRUB:
   - Удаляет старые строки `GRUB_GFXMODE`, `GRUB_TERMINAL`, `GRUB_GFXPAYLOAD_LINUX`, `GRUB_THEME` из `/etc/default/grub` и добавляет:
     - `GRUB_GFXMODE=1920x1080,1280x720,auto`
     - `GRUB_TERMINAL=gfxterm`
     - `GRUB_GFXPAYLOAD_LINUX=keep`
5. Пытается установить пакет тем:
   - `apt-get install -y grub2-themes-ubuntu-mate` или `grub2-common`
   - Ищет `theme.txt` в `/boot/grub/themes` и добавляет `GRUB_THEME='...'` в `/etc/default/grub`. Если темы нет — создаёт `/boot/grub/themes/default` и прописывает путь к предполагаемой теме.
6. Восстанавливает системные скрипты GRUB:
   - `apt-get download grub2-common`, распаковывает .deb и копирует содержимое `ex/etc/grub.d/` в `/etc/grub.d/`, делает скрипты исполняемыми.
7. Переустанавливает EFI-пакеты и устанавливает загрузчик:
   - `apt-get install -y --reinstall grub-efi-amd64-signed shim-signed os-prober`
   - `grub-install --target=x86_64-efi --recheck`
8. Обновляет конфигурацию GRUB:
   - Устанавливает `GRUB_DISABLE_OS_PROBER=false` и запускает `update-grub`.
9. Выводит список обнаруженных записей меню из `/boot/grub/grub.cfg`.

Каждая крупная операция выполняется через функцию-обёртку `run_task`, которая показывает спиннер и фиксирует результат в логе.

## Логирование и отладка
- Весь вывод команд (stdout/stderr) перенаправляется в `/tmp/grub_sentinel.log`.
- При ошибке в консоли будет показана красная метка "✘ ОШИБКА".
- Для дебага просмотрите лог:
```bash
less /tmp/grub_sentinel.log
```
- Рекомендуется запускать скрипт сначала на тестовой машине/VM и проверять содержимое лога перед выполнением операций на продакшне.

## Безопасность и рекомендации
- Скрипт выполняет изменения, которые могут повлиять на загрузку системы. Обязательно:
  - Сделать резервную копию важных данных и раздела EFI.
  - Запускать в среде, где возможен доступ к восстановлению (Live USB / Rescue).
  - Внимательно читать вывод логов и сообщения об ошибках.
- Если система использует BIOS/legacy boot, команды EFI (grub-efi-amd64-signed) не подойдут — измените под вашу архитектуру/целевой загрузчик.
- Скрипт не реализует режим "dry-run" — если хотите, рекомендуется добавить такой режим перед использованием на критичных системах.

## Вклад
Пул-реквесты и issues приветствуются. Пожалуйста, опишите свою платформу и шаги воспроизведения при багрепортах.

## Лицензия
MIT — см. LICENSE в репозитории.

---

Если хотите, я могу:
- Добавить режим `--dry-run` и бэкап перед изменением файлов,
- Создать шаблон issue/PR в репозитории,
- Автоматически добавить `grub_sentinel.sh` в репозиторий и открыть PR (требуются права/ветка и сообщение коммита).
